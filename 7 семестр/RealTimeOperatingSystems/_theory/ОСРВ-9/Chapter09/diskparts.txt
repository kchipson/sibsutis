3 РАЗБИЕНИЕ ДИСКА НА РАЗДЕЛЫ
3.1 Система разделов дисковой подсистемы
Система разделов - одна из наиболее важных элементов в дисковой подсистеме. Ее стандарт не зависит от файловых и операционных систем. Описанная ниже процедура загрузки и разбиения на разделы поддерживается практически всеми ОС для x86-архитектуры.
Раздел – это множество последовательно расположенных секторов на диске, которое воспринимается операционной системой как отдельный независимый диск. Такое деление дискового пространства на разделы позволяет на одном диске создавать файловые системы различных типов, которые могут использоваться различными операционными системами.
Разбиение диска не означает, что диск физически разрезается на несколько разделов – все осуществляется на логическом уровне. Просто создается так называемая таблица разбиения диска - набор индексов или ссылок (адресов), определяющих размещение разделов на диске [4, 8].
Данные о разбиении на разделы хранятся в первом секторе жесткого диска. Но под них отделён не весь первый сектор, а только 64 байта, сразу после которых расположена сигнатура AA55h, которая метит сектор как системный сектор. Это значение существует в каждом секторе структуры разделов (включая загрузочные секторы) и его отсутствие может свидетельствовать о вероятном повреждении структуры разделов. Остальные 446 байт отведены под MBR (Master Boot Record). В этих 446 байтах вписывается маленькая программа, служащая для загрузки ОС. Эта программа может передавать управление следующему звену загрузки из комплекта ОС, но может вести себя и иначе. Как правило, она запускает код, который находится в первом секторе одного из разделов (бутсектор раздела), который в свою очередь запускает следующее звено загрузки. Раздел, загрузочному сектору которого MBR передаёт управление при загрузке, называется активным. Описанный алгоритм часто называют механизмом цепной загрузки.
Активным может быть любой раздел, но одновременно только один. То, какой из разделов является активным, также записано в первом секторе жесткого диска.
Устройство корневого  сектора   диска   представлено  в таблице 3.1.
Таблица 3.1 – Устройство корневого сектора диска
 
Смещение	Размер, байт	Описание 	   
0000h	446	Код начальной загрузки 	   
01Beh 	16	Описатель 1-го основного раздела 	   
01Ceh 	16	Описатель 2-го основного раздела 	   
01Deh 	16	Описатель 3-го основного раздела 	   
01Eeh 	16	Описатель 4-го основного раздела 	   
01Feh 	2	Сигнатура системного байта (0xAA55) 	 

Описатели разделов имеют  форму,   представленную в таблице 3.2.

Таблица 3.2 – Устройство описателя раздела
 
Смещение 	Размер, байт	Описание 	   
0000h 	1	Маркер начальной загрузки 	   
0001h 	1	Головка 	   
0002h 	1	Сектор и Цилиндр (биты 8-9) 	   
0003h 	1	Цилиндр (биты 0-7) 	   
0004h 	1	Системное Описание 	   
0005h 	1	Головка 	   
0006h 	1	Сектор и Цилиндр (биты 8-9) 	   
0007h 	1	Цилиндр (биты 0-7) 	   
0008h 	4	Смещение секторов 	   
000Ch 	4	Количество секторов в разделе 	 

Маркер начальной загрузки – байт, значение которого может быть или 0 или номер диска (80h). Если 80h, тогда раздел является активным разделом диска (разделом начальной загрузки), с которого будет осуществляться загрузка операционной системы. 
Следующие 3 байта содержат информацию о начале размещения раздела (номера головки, цилиндра и сектора). Номера сектора и цилиндра хранятся в двух байтах. Биты 0-7 номера цилиндра сохранены во втором байте, в то время как биты 8-9 сохранены в старших разрядах первого байта. Значение сектора сохранено в битах 0-5 первого байта. 
Далее расположен системный байт, который является идентифицирующим байтом раздела. Значение 0, для разделов не используется, в то время как другие значения зависят от файловой системы. Например, DOS использует значения 1,4 и 6 соответственно для FAT12, FAT16 и раздела BigDOS, значение 5 обозначает расширенный раздел. Некоторые другие кодовые значения файловых систем представлены в таблице А.1.
Затем, идут байты с информацией о размещении конечного сектора раздела (номера головки, цилиндра и сектора).
За ними - значение смещения сектора. Это - число, которое показывает позицию раздела относительно существующего сектора. Так, для основных разделов, это - стартовый сектор раздела. Основные разделы – это разделы, которые описаны в корневой структуре разделения.
В последнем элементе описателя находится информация о длине раздела (в секторах).
Когда диск работает в режиме LBA (логической адресации блоков), значения CHS (цилиндр – головка – сектор) для начала и конца размещения игнорируются. Отображение диска выполняется с абсолютным номером сектора, а не в терминах CHS (cylinder-head-sector). Таким образом, относительное значение сектора и длина раздела используются для идентификации объема раздела на диске. CHS значения вообще недопустимы для дисков объемом более чем 8.4GB.
Из-за ограниченности первого сектора на жестком диске можно создавать не более четырёх разделов, что причиняет некоторые неудобства, если необходимо установить более четырёх файловых систем на одном физическом диске. В связи с этим была разработана архитектура логических разделов. При этом создаётся один расширенный раздел, в котором находится информация о встроенных в него разделах, называемых логические разделы.
Начало расположения основного дополнительного раздела указывает на первый дополнительный раздел. Объем, который занимает основной дополнительный раздел, зарезервирован для логических дисков. Все дополнительные разделы содержат информацию относительно соответствующих им логических дисков, аналогично MBR, описанному выше, но без части кода начальной загрузки. Каждый дополнительный раздел также имеет 4 описателя, но используются только первые два. Первый описатель идентифицирует соответствующий логический диск, а второй является описателем, указывающим на следующий логический диск в цепочке разделов. Таким образом, структура разделов - структура списка связей, которая может быть такой длины, какой необходимо.
Рассмотрим пример разбиения диска на разделы, изображённый на рисунке 3.1.
Активность
Тип
CHS начало
CHS конец
Начало
Длина
         **              12             0      1      1      1023  254   63              63               20514942
                           15        1023     0      1      1023  254   63        20515005         17446590
Активность
Тип
CHS начало
CHS конец
Начало
Длина
                           12        1023     1      1      1023  254   63              63               15374142
                            5         1023     0      1      1023  254   63        15374205          2072385
Активность
Тип
CHS начало
CHS конец
Начало
Длина
                           79        1023     1      1      1023  254   63              63                2072322
                            0              0      0      0          0      0      0                0                       0
                            0              0      0      0          0      0      0                0                       0
                            0              0      0      0          0      0      0                0                       0
                            0              0      0      0          0      0      0                0                       0
                            0              0      0      0          0      0      0                0                       0
                           79        1023     0      1      1023  254   63        37961595         2056320
                            0              0      0      0          0      0      0                0                       0
П  (C:)
Р
Л  (D:)
Р 
Л  (E:)
П  (F:)
П – первичный раздел;
Р – расширенный раздел;
Л – логический раздел.
полный диск
П [---------- C: ------------]
Л [------ D: ------]     остаток  -
П [-­- F: --]
Л [-- E: --]
расширенный раздел

Рисунок 3.1 – Пример разбиения диска на разделы

В соответствии с рисунком 3.1, диск разбит на два первичных и два логических раздела. В терминах Windows, этим разделам присвоятся имена C, D, E и F.
Все записи о расширенных разделах представляют собой связанную цепь, в которой от дискового пространства отщипываются кусочки на обычные разделы, пока место не кончится (в этом случае очередной элемент цепи не содержит записи о расширенном разделе).
